"use strict";
<<<<<<< HEAD
const DOMException = require("domexception");
const idlUtils = require("../generated/utils");
const conversions = require("webidl-conversions");

// TODO: Once NodeFilter is ported to IDL method, use those instead.
=======
const DOMException = require("domexception/webidl2js-wrapper");
const conversions = require("webidl-conversions");

>>>>>>> b459a022f47e1c55fb538e6c6b01f47908ccd92f
exports.FILTER_ACCEPT = 1; // NodeFilter.FILTER_ACCEPT
exports.FILTER_REJECT = 2; // NodeFilter.FILTER_REJECT
exports.FILTER_SKIP = 3; // NodeFilter.FILTER_SKIP

exports.filter = (nodeIteratorOrTreeWalkerImpl, nodeImpl) => {
  if (nodeIteratorOrTreeWalkerImpl._active) {
<<<<<<< HEAD
    throw new DOMException("Recursive node filtering", "InvalidStateError");
=======
    throw DOMException.create(nodeIteratorOrTreeWalkerImpl._globalObject, [
      "Recursive node filtering",
      "InvalidStateError"
    ]);
>>>>>>> b459a022f47e1c55fb538e6c6b01f47908ccd92f
  }

  const n = nodeImpl.nodeType - 1;

  if (!((1 << n) & nodeIteratorOrTreeWalkerImpl.whatToShow)) {
    return exports.FILTER_SKIP;
  }

  // Saving in a variable is important so we don't accidentally call it as a method later.
  const { filter } = nodeIteratorOrTreeWalkerImpl;

  if (filter === null) {
    return exports.FILTER_ACCEPT;
  }

  nodeIteratorOrTreeWalkerImpl._active = true;

  let result;

  // https://github.com/whatwg/dom/issues/494
  try {
<<<<<<< HEAD
    if (typeof filter === "function") {
      result = filter(idlUtils.wrapperForImpl(nodeImpl));
    } else {
      result = filter.acceptNode(idlUtils.wrapperForImpl(nodeImpl));
    }
=======
    result = filter(nodeImpl);
>>>>>>> b459a022f47e1c55fb538e6c6b01f47908ccd92f
  } finally {
    nodeIteratorOrTreeWalkerImpl._active = false;
  }

  result = conversions["unsigned short"](result);

  return result;
};
