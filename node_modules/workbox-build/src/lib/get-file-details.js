/*
  Copyright 2018 Google LLC

  Use of this source code is governed by an MIT-style
  license that can be found in the LICENSE file or at
  https://opensource.org/licenses/MIT.
*/

const glob = require('glob');
<<<<<<< HEAD
const path = require('path');
=======
const upath = require('upath');
>>>>>>> b459a022f47e1c55fb538e6c6b01f47908ccd92f

const errors = require('./errors');
const getFileSize = require('./get-file-size');
const getFileHash = require('./get-file-hash');

<<<<<<< HEAD
module.exports = (globOptions) => {
  const {
    globDirectory,
    globFollow,
    globIgnores,
    globPattern,
    globStrict,
  } = globOptions;
  let globbedFiles;
=======
module.exports = ({
  globDirectory,
  globFollow,
  globIgnores,
  globPattern,
  globStrict,
}) => {
  let globbedFiles;
  let warning;

>>>>>>> b459a022f47e1c55fb538e6c6b01f47908ccd92f
  try {
    globbedFiles = glob.sync(globPattern, {
      cwd: globDirectory,
      follow: globFollow,
      ignore: globIgnores,
      strict: globStrict,
    });
  } catch (err) {
    throw new Error(errors['unable-to-glob-files'] + ` '${err.message}'`);
  }

  if (globbedFiles.length === 0) {
<<<<<<< HEAD
    throw new Error(errors['useless-glob-pattern'] + ' ' +
      JSON.stringify({globDirectory, globPattern, globIgnores}, null, 2));
  }

  const fileDetails = globbedFiles.map((file) => {
    const fullPath = path.join(globDirectory, file);
=======
    warning = errors['useless-glob-pattern'] + ' ' +
      JSON.stringify({globDirectory, globPattern, globIgnores}, null, 2);
  }

  const fileDetails = globbedFiles.map((file) => {
    const fullPath = upath.join(globDirectory, file);
>>>>>>> b459a022f47e1c55fb538e6c6b01f47908ccd92f
    const fileSize = getFileSize(fullPath);
    if (fileSize === null) {
      return null;
    }

    const fileHash = getFileHash(fullPath);
    return {
<<<<<<< HEAD
      file: `${path.relative(globDirectory, fullPath)}`,
=======
      file: `${upath.relative(globDirectory, fullPath)}`,
>>>>>>> b459a022f47e1c55fb538e6c6b01f47908ccd92f
      hash: fileHash,
      size: fileSize,
    };
  });

  // If !== null, means it's a valid file.
<<<<<<< HEAD
  return fileDetails.filter((details) => details !== null);
=======
  const globbedFileDetails = fileDetails.filter((details) => details !== null);

  return {globbedFileDetails, warning};
>>>>>>> b459a022f47e1c55fb538e6c6b01f47908ccd92f
};
